name: BETA Test

on:
  workflow_dispatch:
  push:

jobs:
  test:
    concurrency:
      group: beta-test
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'oracle'
          java-version: '17'
      - uses: Xotabu4/selenoid-github-action@v2
      - name: test
        run: ./gradlew clean tests_on_selenoid -Dbrowser_version="100.0" -Dbrowser_size="1920x1080" -Dbrowser_host="selenoid.autotests.cloud/wd/hub"

      - name: check build directory
        if: success() || failure()
        run: ls -la build

      - name: Report failed tests
        if: success() || failure()
        id: failed-tests-extractor
        uses: ./.github/actions/failed-tests-extractor

      - name: check output
        if: success() || failure()
        run: echo "${{ steps.failed-tests-extractor.outputs.failed_tests }}"

      - uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: beta-test-results-${{ github.run_number }}
          path: build/allure-results
          retention-days: 1
          if-no-files-found: error

  deploy-test-result:
    needs: test
    if: success() || failure()
    uses: ./.github/workflows/deploy-test-result-to-pages.yml
    with:
      results-artifact-name: beta-test-results-${{ github.run_number }}
      env: beta
